const fs = require('fs');
const path = require('path');

console.log('üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1608...');

const filePath = path.join(__dirname, 'server.js');
let content = fs.readFileSync(filePath, 'utf8');

// –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
const backupPath = path.join(__dirname, 'server.js.backup_line_1608');
fs.writeFileSync(backupPath, content);
console.log('üìÅ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è:', backupPath);

// –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
const lines = content.split('\n');

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∫—Ä—É–≥ —Å—Ç—Ä–æ–∫–∏ 1608
console.log('\nüìã –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ 1608:');
for (let i = 1595; i <= 1625; i++) {
    console.log(`${i}: ${lines[i-1]}`);
}

// –ò—â–µ–º –ø—Ä–æ–±–ª–µ–º—É - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –∏–ª–∏ –º–∞—Å—Å–∏–≤
// –î–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ–±–ª–µ–º—ã
let problemStart = 1600;
let problemFound = false;

console.log('\nüîç –ò—â—É –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –±–ª–æ–∫...');

// –ü—Ä–æ–≤–µ—Ä–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç 1590 –¥–æ 1620 —Å—Ç—Ä–æ–∫–∏
for (let i = 1590; i < 1620; i++) {
    const line = lines[i-1];
    
    // –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
    if (line.includes('detailed_15:') && line.includes('[')) {
        console.log(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –±–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–æ–∫–µ ${i}: ${line}`);
        
        // –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –≤—ã—à–µ
        console.log('–°—Ç—Ä–æ–∫–∏ –≤—ã—à–µ:');
        for (let j = i-10; j < i; j++) {
            console.log(`${j}: ${lines[j-1]}`);
        }
        
        // –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ
        console.log('–°—Ç—Ä–æ–∫–∏ –Ω–∏–∂–µ:');
        for (let j = i; j < i+10; j++) {
            console.log(`${j}: ${lines[j-1]}`);
        }
        
        problemFound = true;
        break;
    }
}

if (!problemFound) {
    console.log('\n‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –±–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.');
    console.log('–ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤—Ä—É—á–Ω—É—é...');
    
    // –í—ã–≤–µ–¥–µ–º –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    console.log('\nüìä –ë–æ–ª—å—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (1580-1650):');
    for (let i = 1580; i <= 1650; i++) {
        if (i === 1608) console.log(`>>> ${i}: ${lines[i-1]} <<< –ü–†–û–ë–õ–ï–ú–ê`);
        else console.log(`${i}: ${lines[i-1]}`);
    }
}

// –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
console.log('\nüí° –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ:');
console.log('1. –ï—Å—Ç—å –æ–±—ä–µ–∫—Ç –±–µ–∑ –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ detailed_15');
console.log('2. –ò–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø—è—Ç–∞—è/–¥–≤–æ–µ—Ç–æ—á–∏–µ');
console.log('3. –ò–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –º–∞—Å—Å–∏–≤–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞');

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - —É–¥–∞–ª–∏–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∑–∞–º–µ–Ω–∏–º –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–¥
console.log('\nüîß –ü—Ä–æ–±—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');

// –ù–∞–π–¥–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç 1590 –¥–æ 1620 –∏ –∑–∞–º–µ–Ω–∏–º
let fixedLines = [];

for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const lineNumber = i + 1;
    
    if (lineNumber >= 1590 && lineNumber <= 1620) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        if (lineNumber === 1608) {
            console.log(`üö´ –£–¥–∞–ª—è—é –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É ${lineNumber}: ${line}`);
            // –í–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è, –∑–∞–º–µ–Ω–∏–º –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥
            fixedLines.push('            detailed_15: ['); // –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        } else if (lineNumber >= 1609 && lineNumber <= 1625) {
            // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏
            if (line.trim() === ']' || line.includes('};')) {
                // –≠—Ç–æ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º
                fixedLines.push(line);
            } else if (line.includes('"Vision"') || line.includes('"Title Slide"')) {
                // –≠—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º
                fixedLines.push(line);
            } else {
                console.log(`‚ö†Ô∏è  –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä–æ–∫—É ${lineNumber}: ${line}`);
                // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
                if (line.includes(':')) {
                    // –ü–æ—Ö–æ–∂–µ –Ω–∞ —Å–≤–æ–π—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–∞, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—è—Ç—É—é
                    fixedLines.push(line.replace(/:$/, ':'));
                } else {
                    fixedLines.push(line);
                }
            }
        } else {
            fixedLines.push(line);
        }
    } else {
        fixedLines.push(line);
    }
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
const fixedPath = path.join(__dirname, 'server_line_fixed.js');
fs.writeFileSync(fixedPath, fixedLines.join('\n'));
console.log('\n‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫:', fixedPath);

console.log('\nüß™ –ü—Ä–æ–≤–µ—Ä—è—é —Å–∏–Ω—Ç–∞–∫—Å–∏—Å...');
try {
    // –ü—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    require('vm').createScript(fixedLines.join('\n'), 'test.js');
    console.log('‚úÖ –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω');
} catch (e) {
    console.log('‚ùå –û—Å—Ç–∞–ª–∏—Å—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:', e.message);
}

console.log('\nüöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:');
console.log('   node server_line_fixed.js');
console.log('\nüìã –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä–æ–∫–∏ 1590-1625 –≤—Ä—É—á–Ω—É—é.');