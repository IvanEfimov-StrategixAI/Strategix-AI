const axios = require('axios');
const https = require('https');
const { v4: uuidv4 } = require('uuid');
const { gigachat } = require('../config');

class GigaChatService {
  constructor() {
    this.baseUrl = gigachat.baseUrl;
    this.authUrl = gigachat.authUrl;
    this.apiKey = gigachat.apiKey;
    this.scope = gigachat.scope;
    this.currentToken = null;
    this.tokenExpiry = null;
    this.requestCache = new Map();
    
    // HTTPS –∞–≥–µ–Ω—Ç –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
    this.httpsAgent = new https.Agent({
      rejectUnauthorized: false,
      keepAlive: true
    });
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async getToken() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ –∫—ç—à–µ
    if (this.currentToken && this.tokenExpiry && Date.now() < this.tokenExpiry) {
      return this.currentToken;
    }

    console.log('üîë –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ GigaChat...');
    
    try {
      let encodedCredentials;
      
      if (this.apiKey.includes(':')) {
        encodedCredentials = Buffer.from(this.apiKey).toString('base64');
      } else {
        encodedCredentials = this.apiKey;
      }

      const response = await axios({
        method: 'post',
        url: this.authUrl,
        data: `scope=${this.scope}`,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
          'Authorization': `Basic ${encodedCredentials}`,
          'RqUID': uuidv4()
        },
        httpsAgent: this.httpsAgent,
        timeout: 30000
      });

      if (!response.data?.access_token) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      }

      this.currentToken = response.data.access_token;
      this.tokenExpiry = response.data.expires_at 
        ? response.data.expires_at 
        : Date.now() + (3600 * 1000); // 1 —á–∞—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

      console.log('‚úÖ –¢–æ–∫–µ–Ω GigaChat —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!');
      return this.currentToken;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ GigaChat:', error.message);
      
      if (error.response?.status === 401) {
        console.error(' ‚ö†Ô∏è –û—à–∏–±–∫–∞ 401: –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
      }
      
      throw new Error(`GigaChat API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
    }
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ GigaChat
  async chat(messages, options = {}) {
    const {
      temperature = 0.7,
      maxTokens = 4000,
      model = 'GigaChat',
      stream = false,
      useCache = true,
      cacheKey = null
    } = options;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    if (useCache && cacheKey) {
      const cachedResponse = this.requestCache.get(cacheKey);
      if (cachedResponse) {
        console.log('üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç');
        return cachedResponse;
      }
    }

    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt} –≤—ã–∑–æ–≤–∞ GigaChat API...`);
        
        const token = await this.getToken();

        const response = await axios({
          method: 'POST',
          url: `${this.baseUrl}/chat/completions`,
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          data: {
            model,
            messages,
            temperature,
            max_tokens: maxTokens,
            stream
          },
          httpsAgent: this.httpsAgent,
          timeout: 60000
        });

        if (response.data?.choices?.[0]?.message?.content) {
          const result = response.data.choices[0].message.content;
          
          // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          if (useCache && cacheKey) {
            this.requestCache.set(cacheKey, result);
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞
            if (this.requestCache.size > 100) {
              const firstKey = this.requestCache.keys().next().value;
              this.requestCache.delete(firstKey);
            }
          }
          
          console.log('‚úÖ –û—Ç–≤–µ—Ç GigaChat –ø–æ–ª—É—á–µ–Ω');
          return result;
        } else {
          throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç –æ—Ç GigaChat');
        }
      } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ GigaChat API (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}):`, error.message);
        
        if (attempt === 3) {
          throw new Error(`GigaChat API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: ${error.message}`);
        }
        
        const delay = 2000 * Math.pow(2, attempt - 1);
        console.log(` ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ${delay}ms –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...`);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
  async generateBusinessContent(prompt, context = '', options = {}) {
    const messages = [
      {
        role: 'system',
        content: `–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å 20+ –ª–µ—Ç –æ–ø—ã—Ç–∞. 
                 –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏, —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.
                 –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.
                 –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${context}`
      },
      { role: 'user', content: prompt }
    ];

    return this.chat(messages, {
      temperature: options.temperature || 0.7,
      maxTokens: options.maxTokens || 4000,
      ...options
    });
  }

  // –ê–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏
  async analyzeBusinessIdea(businessIdea, options = {}) {
    const prompt = `–ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É:

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –∞—Å–ø–µ–∫—Ç—ã:
1. –†–´–ù–û–ß–ù–´–ô –ü–û–¢–ï–ù–¶–ò–ê–õ
   - –†–∞–∑–º–µ—Ä —Ä—ã–Ω–∫–∞ (TAM/SAM/SOM)
   - –¢—Ä–µ–Ω–¥—ã –∏ –¥—Ä–∞–π–≤–µ—Ä—ã —Ä–æ—Å—Ç–∞
   - –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ª–∞–Ω–¥—à–∞—Ñ—Ç

2. –§–ò–ù–ê–ù–°–û–í–ê–Ø –ñ–ò–ó–ù–ï–°–ü–û–°–û–ë–ù–û–°–¢–¨
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç
   - –ú–æ–¥–µ–ª—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏
   - –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏

3. –¢–ï–•–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –ê–°–ü–ï–ö–¢–´
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
   - –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏

4. –†–ò–°–ö–ò –ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò
   - –ö–ª—é—á–µ–≤—ã–µ —Ä–∏—Å–∫–∏
   - –ë–∞—Ä—å–µ—Ä—ã –≤—Ö–æ–¥–∞
   - –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
   - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–∏—Ç–∏–≥–∞—Ü–∏–∏

5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø MVP
   - –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
   - –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

–í–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –æ—Ü–µ–Ω–∫–∞–º–∏.`;

    return this.generateBusinessContent(prompt, 'business_analysis', options);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è MVP —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
  async generateMVPSpecification(businessIdea, userRequirements = '', options = {}) {
    const prompt = `–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é MVP –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∏–∑–Ω–µ—Å-–∏–¥–µ–∏:

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}
–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø: ${userRequirements}

–°–æ–∑–¥–∞–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –≤–∫–ª—é—á–∞—é—â—É—é:
1. –¶–ï–õ–ò MVP
   - –û—Å–Ω–æ–≤–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
   - –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏

2. –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (must have)
   - –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (should have)
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (could have)

3. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
   - –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

4. –î–ò–ó–ê–ô–ù –ò UX
   - –û—Å–Ω–æ–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
   - –í–∞–π—Ä—Ñ—Ä–µ–π–º—ã
   - UI/UX —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

5. –ü–õ–ê–ù –†–ê–ó–†–ê–ë–û–¢–ö–ò
   - –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
   - –ù–µ–æ–±—Ö–æ–¥–∏–º–∞—è –∫–æ–º–∞–Ω–¥–∞
   - –ë—é–¥–∂–µ—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

–í–µ—Ä–Ω–∏ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é —Å –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–æ–π –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.`;

    return this.generateBusinessContent(prompt, 'mvp_specification', {
      maxTokens: 6000,
      ...options
    });
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –∫–æ–¥–∞ –¥–ª—è MVP
  async generateMVPHTML(businessIdea, specifications = '', options = {}) {
    const prompt = `–°–û–ó–î–ê–ô –ü–û–õ–ù–û–¶–ï–ù–ù–´–ô MVP HTML –ö–û–î –° –ù–£–õ–Ø!

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}
–°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø: ${specifications}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö HTML –ö–û–î–£:
1. –ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨
   - –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –†–ê–ë–û–¢–ê–¢–¨
   - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
   - –§–æ—Ä–º—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç

2. –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù
   - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI/UX
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞
   - –ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
   - –¶–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã

3. –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô –ö–û–î
   - –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞
   - –ß–∏—Å—Ç—ã–π CSS —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
   - ES6+ JavaScript
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

4. –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø
   - –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
   - SEO-friendly
   - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (a11y)
   - –ö—Ä–æ—Å—Å–±—Ä–∞—É–∑–µ—Ä–Ω–æ—Å—Ç—å

–°–¢–†–£–ö–¢–£–†–ê MVP:
- Header —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
- Hero —Å–µ–∫—Ü–∏—è —Å —Ü–µ–Ω–Ω–æ—Å—Ç–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
- –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª (—Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å)
- Features/benefits —Å–µ–∫—Ü–∏—è
- About/team —Å–µ–∫—Ü–∏—è
- Contact/CTA —Å–µ–∫—Ü–∏—è
- Footer

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –ü–û–õ–ù–´–ô HTML —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
–í–µ—Å—å CSS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ <style> —Ç–µ–≥–µ.
–í–µ—Å—å JS –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ <script> —Ç–µ–≥–µ.`;

    return this.chat([{ role: 'user', content: prompt }], {
      temperature: 0.3,
      maxTokens: 8000,
      ...options
    });
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞
  async generateBusinessPlan(businessIdea, options = {}) {
    const prompt = `–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–¥–µ–∏:

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω–∞:
1. –†–ï–ó–Æ–ú–ï –ü–†–û–ï–ö–¢–ê
2. –ê–ù–ê–õ–ò–ó –†–´–ù–ö–ê
   - –†–∞–∑–º–µ—Ä –∏ –¥–∏–Ω–∞–º–∏–∫–∞ —Ä—ã–Ω–∫–∞
   - –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
   - –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
   - –¢—Ä–µ–Ω–¥—ã –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

3. –û–ü–ò–°–ê–ù–ò–ï –ë–ò–ó–ù–ï–°–ê
   - –ú–∏—Å—Å–∏—è –∏ —Ü–µ–ª–∏
   - –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å
   - –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
   - SWOT-–∞–Ω–∞–ª–∏–∑

4. –û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ô –ü–õ–ê–ù
   - –ü—Ä–æ—Ü–µ—Å—Å—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   - –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –∏ –ø–∞—Ä—Ç–Ω–µ—Ä—ã
   - –ü–µ—Ä—Å–æ–Ω–∞–ª –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
   - –õ–æ–∫–∞—Ü–∏—è –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ

5. –ú–ê–†–ö–ï–¢–ò–ù–ì–û–í–´–ô –ü–õ–ê–ù
   - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è
   - –¶–µ–Ω–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞
   - –ö–∞–Ω–∞–ª—ã –ø—Ä–æ–¥–∞–∂
   - –ü–ª–∞–Ω –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π

6. –§–ò–ù–ê–ù–°–û–í–´–ô –ü–õ–ê–ù
   - –ù–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
   - –ü—Ä–æ–≥–Ω–æ–∑ –≤—ã—Ä—É—á–∫–∏
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç
   - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
   - –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤

7. –ü–õ–ê–ù –†–ê–ó–í–ò–¢–ò–Ø
   - –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞
   - –ö–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã
   - –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
   - –ü–ª–∞–Ω –Ω–∞ 1-3-5 –ª–µ—Ç

–í–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏.`;

    return this.generateBusinessContent(prompt, 'business_plan', {
      maxTokens: 7000,
      ...options
    });
  }

  // –ê–Ω–∞–ª–∏–∑ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏
  async analyzeUnitEconomics(businessDescription, options = {}) {
    const prompt = `–ü—Ä–æ–≤–µ–¥–∏ –∞–Ω–∞–ª–∏–∑ —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞:

–û–ü–ò–°–ê–ù–ò–ï –ë–ò–ó–ù–ï–°–ê: ${businessDescription}

–†–∞—Å—Å—á–∏—Ç–∞–π –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:
1. –ö–õ–Æ–ß–ï–í–´–ï –ú–ï–¢–†–ò–ö–ò
   - CAC (Customer Acquisition Cost)
   - LTV (Lifetime Value)
   - LTV:CAC Ratio
   - Churn Rate
   - Gross Margin

2. –§–ò–ù–ê–ù–°–û–í–´–ï –ü–†–û–ì–ù–û–ó–´
   - –ü—Ä–æ–≥–Ω–æ–∑ –≤—ã—Ä—É—á–∫–∏ –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç
   - –¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏
   - ROI –∏ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å

3. –ë–ò–ó–ù–ï–°-–ú–û–î–ï–õ–¨
   - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞
   - –¶–µ–Ω–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
   - –ö–∞–Ω–∞–ª—ã –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏
   - –£–ª—É—á—à–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
   - –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–æ—Å—Ç–∞

–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–æ–ø—É—â–µ–Ω–∏—è –∏ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–∏.
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ä–∞—Å—á–µ—Ç—ã.`;

    return this.generateBusinessContent(prompt, 'unit_economics', options);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è pitch deck
  async generatePitchDeck(businessIdea, options = {}) {
    const prompt = `–°–æ–∑–¥–∞–π —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π pitch deck –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ pitch deck (10-15 —Å–ª–∞–π–¥–æ–≤):
1. TITLE SLIDE (–ù–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–º–∞–Ω–¥–∞, –∫–æ–Ω—Ç–∞–∫—Ç—ã)
2. THE PROBLEM (–ü—Ä–æ–±–ª–µ–º–∞, —Ä–∞–∑–º–µ—Ä, –±–æ–ª—å)
3. THE SOLUTION (–ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç)
4. WHY NOW? (–ü–æ—á–µ–º—É —Å–µ–π—á–∞—Å, —Ç—Ä–µ–Ω–¥—ã)
5. MARKET SIZE (TAM/SAM/SOM, –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
6. PRODUCT (–î–µ–º–æ, —Ñ–∏—á–∏, –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞)
7. BUSINESS MODEL (–ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è, —Ü–µ–Ω—ã, –º–µ—Ç—Ä–∏–∫–∏)
8. COMPETITION (–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã, –æ—Ç–ª–∏—á–∏—è, –±–∞—Ä—å–µ—Ä—ã)
9. TEAM (–û–ø—ã—Ç, –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏, –ø–æ—á–µ–º—É –º—ã)
10. TRACTION (–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è, –º–µ—Ç—Ä–∏–∫–∏, —Ä–æ—Å—Ç)
11. FINANCIALS (–í—ã—Ä—É—á–∫–∞, —Ä–∞—Å—Ö–æ–¥—ã, –ø—Ä–æ–≥–Ω–æ–∑—ã)
12. THE ASK (–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –æ—Ü–µ–Ω–∫–∞)
13. ROADMAP (–ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è, –≤–µ—Ö–∏)
14. RISKS & MITIGATION (–†–∏—Å–∫–∏, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
15. CONTACT & Q&A (–ö–æ–Ω—Ç–∞–∫—Ç—ã, –≤–æ–ø—Ä–æ—Å—ã)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
- –ó–∞–≥–æ–ª–æ–≤–æ–∫
- 3-5 –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ–∑–∏—Å–æ–≤
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–∞–Ω–Ω—ã–µ
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- Speaker notes

–°–¥–µ–ª–∞–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.`;

    return this.generateBusinessContent(prompt, 'pitch_deck', {
      maxTokens: 6000,
      ...options
    });
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  async generateLegalDocuments(businessIdea, documentType = 'nda', options = {}) {
    const prompts = {
      nda: `–°–æ–∑–¥–∞–π –¥–æ–≥–æ–≤–æ—Ä –æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ (NDA) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞.
            –ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è: ${businessIdea}
            –í–∫–ª—é—á–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è NDA, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ IT-—Å—Ç–∞—Ä—Ç–∞–ø.`,
      
      incorporation: `–°–æ–∑–¥–∞–π —É—á—Ä–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è IT-–∫–æ–º–ø–∞–Ω–∏–∏.
                     –ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è: ${businessIdea}
                     –í–∫–ª—é—á–∏ —Ä–∞–∑–¥–µ–ª—ã: –æ–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è, —Ü–µ–ª–∏, —É—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª,
                     –ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —É—á—Ä–µ–¥–∏—Ç–µ–ª–µ–π, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏.`,
      
      employment: `–°–æ–∑–¥–∞–π —Ç—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ IT-–∫–æ–º–ø–∞–Ω–∏–∏.
                  –ë–∏–∑–Ω–µ—Å-–∏–¥–µ—è: ${businessIdea}
                  –í–∫–ª—é—á–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ IT-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏.`
    };

    const prompt = prompts[documentType] || prompts.nda;

    return this.generateBusinessContent(prompt, 'legal_documents', {
      temperature: 0.2,
      ...options
    });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö
  async validateBusinessData(data, context = '', options = {}) {
    const prompt = `–ü—Ä–æ–≤–µ—Ä—å –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å:

–î–ê–ù–ù–´–ï: ${JSON.stringify(data, null, 2)}
–ö–û–ù–¢–ï–ö–°–¢: ${context}

–ü—Ä–æ–≤–µ—Ä—å:
1. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã –ª–∏ —Ç–µ–º–ø—ã —Ä–æ—Å—Ç–∞?)
2. –†—ã–Ω–æ—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏?)
3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ–ø—É—â–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–∏–º—ã –ª–∏ –æ–Ω–∏?)
4. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã –ª–∏ —Å—Ä–æ–∫–∏?)
5. –†–µ—Å—É—Ä—Å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã –ª–∏ —Ä–µ—Å—É—Ä—Å—ã?)

–í–µ—Ä–Ω–∏ –∞–Ω–∞–ª–∏–∑ —Å:
- –û—Ü–µ–Ω–∫–æ–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏ (0-100%)
- –°–ø–∏—Å–∫–æ–º –ø—Ä–æ–±–ª–µ–º –∏ —Ä–∏—Å–∫–æ–≤
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏

–ë—É–¥—å –∫—Ä–∏—Ç–∏—á–Ω—ã–º –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º.`;

    return this.generateBusinessContent(prompt, 'business_validation', options);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
  async generateInvestorAnswers(businessIdea, questions = [], options = {}) {
    const prompt = `–ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:

–ë–ò–ó–ù–ï–°-–ò–î–ï–Ø: ${businessIdea}
–í–û–ü–†–û–°–´ –ò–ù–í–ï–°–¢–û–†–û–í: ${questions.join('\n')}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–¥–≥–æ—Ç–æ–≤—å:
1. –ü—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
3. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ/—Ñ–∞–∫—Ç—ã
4. –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—á–µ

–§–æ–∫—É—Å –Ω–∞:
- –ö–æ–Ω–∫—Ä–µ—Ç–∏–∫—É –∏ —Ü–∏—Ñ—Ä—ã
- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
- –ß–µ—Ç–∫—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–æ—Å—Ç–∞

–°–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç—ã —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –æ—Ç–≤–µ—á–∞—é—â–∏–º–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ–ø–∞—Å–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.`;

    return this.generateBusinessContent(prompt, 'investor_qa', {
      maxTokens: 5000,
      ...options
    });
  }

  // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
  clearCache() {
    this.requestCache.clear();
    this.currentToken = null;
    this.tokenExpiry = null;
    console.log('üßπ –ö—ç—à GigaChat –æ—á–∏—â–µ–Ω');
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
  async checkAvailability() {
    try {
      await this.getToken();
      return { available: true, message: 'GigaChat API –¥–æ—Å—Ç—É–ø–µ–Ω' };
    } catch (error) {
      return { 
        available: false, 
        message: 'GigaChat API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 
        error: error.message 
      };
    }
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞
module.exports = new GigaChatService();